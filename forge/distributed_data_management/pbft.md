# Practical Byzantine Fault Tolerance (PBFT)
### Introduction to PBFT
PBFT(Practical Byzantine Fault Tolerance)는 악의적이거나 결함이 있는 노드가 있음에도 불구하고
노드 그룹(cluster)이 공유 상태에 대한 합의에 도달할 수 있도록 하는 분산 시스템용으로 설계된 합의 알고리즘이다.

PBFT는 1999년 [Miguel Castro와 Barbara Liskov의 논문](https://pmg.csail.mit.edu/papers/osdi99.pdf) 에서 처음 소개되었다.
그 이후로 높은 처리량과 내결함성을 요구하는 블록체인 및 기타 분산 시스템을 위한 대중적인 합의 알고리즘이 되었다.

PBFT는 분산 시스템이 중앙 시스템에 의존하지 않고 합의에 도달할 수 있는 방법을 제공하기 때문에 탈중앙화의 핵심 요소이다.
이로 인해 PBFT는 분산되고 신뢰할 수 없도록 설계된 블록체인 시스템에 특히 유용하다.
PBFT는 또한 네트워크에서 최대 1/3의 Byzantine 노드를 허용할 수 있다는 장점이 있어 강력하고 탄력적인 합의 알고리즘이 된다.

* PBFT의 맥락에서 `Byzantine`이라는 용어는 네트워크에서 악의적이거나 독단적으로 행동하는 노드를 의미한다.
  여기에는 유효하지 않은 메시지를 보내거나 정보를 유보하는 등 의도적으로 합의 프로세스를 방해하려는 노드가 포함된다.
* PBFT는 비잔틴 결함에 대해 탄력적으로 설계되었다. 즉, 네트워크 노드의 최대 1/3이 비잔틴 노드인 경우에도 계속해서 올바르게 작동할 수 있다.
  이것은 `Byzantine fault tolerance threshold` 또는 `f+1` 규칙으로 알려져 있다.
  여기서 `f`는 시스템이 허용할 수 있는 결함이 있는 노드의 최대 수를 나타내고 `+1`은 합의에 필요한 올바른 노드의 최소 수를 나타낸다.
* 예를 들어, 노드가 100개이고 비잔틴 내결함성 임계값이 33%인 네트워크에서 네트워크는 최대 33개의 비잔틴 노드를 허용하면서 여전히 합의에 도달할 수 있다.
  이는 최소 67개의 노드가 정확하고 정직하게 행동하는 한 네트워크가 합의를 유지하고 계속해서 올바르게 작동할 수 있음을 의미한다.
* Byzantine faults를 허용하는 기능은 PBFT의 핵심 기능이며 악의적인 노드가 있는 경우에도 합의를 유지할 수 있어야 하는
  블록체인 네트워크와 같은 분산 시스템을 위한 강력한 합의 알고리즘이다.

### Overview of Byzantine Fault Tolerance (BFT)
`Byzantine`이라는 용어는 `Byzantine Generals' Problem`에서 유래한 것으로, 장군들의 집단이 공동의 적을 공격하는 데 협력해야 하지만
일부 장군은 계획을 훼손하려는 traitor일 수 있다는 theoretical 문제이다.
이 문제는 노드의 분산 네트워크를 조정하는 문제와 유사하며 그 중 일부는 결함이 있거나 악의적일 수 있다는 점에서 유사하다.

BFT 알고리즘은 노드의 분산 네트워크가 Byzantine faults가 있는 경우에도 공유 상태에 대한 합의에 도달할 수 있도록 설계되었다.
이러한 알고리즘은 일반적으로 노드 간의 일련의 메시지 교환을 포함하며 각 노드는 현재 상태에 대한 정보를 요청하고 확인하기 위해 피어에 메시지를 보낸다.
노드는 암호화 메커니즘을 사용하여 메시지가 인증되고 악의적인 행위자가 노드를 조작할 수 없도록 한다.

BFT는 결함이 있거나 악의적인 노드가 있는 경우에도 계속해서 올바르게 작동할 수 있기 때문에 분산 시스템에 중요다.
이렇게 하면 공격자가 악용할 수 있는 시스템 전체 오류 또는 보안 취약점을 방지할 수 있다.
BFT는 실패 또는 악의적인 행동이 심각한 결과를 초래할 수 있는 금융 네트워크 또는 군사 명령 및 제어 시스템과 같은 중요한 시스템에 특히 중요하다.

그러나 BFT 알고리즘에도 한계가 있다. 한 가지 제한 사항은 내결함성을 달성하기 위해 네트워크에서 일정량의 redundancy가 필요하다는 것이다.
이는 리소스 측면에서 비용이 많이 들고 확장성을 제한할 수 있다.
또한 BFT 알고리즘은 일반적으로 네트워크의 노드 간에 특정 수준의 신뢰(67%)를 가정하며 실제 시나리오에서는 가정이 성립하지 않을 수 있다.

전반적으로 BFT는 강력하고 안전한 분산 시스템의 개발을 가능하게 하는 분산 컴퓨팅의 중요한 개념이다.
한계가 있지만 중요한 시스템의 복원력과 보안을 보장하는 중요한 도구로 사용된다.

### How PBFT works
#### PBFT Consensus Process
PBFT 합의 프로세스는 4단계로 구성된다.

1. Request Phase: 클라이언트가 primary node에 요청을 보낸다.
2. Pre-prepare Phase: The primary node는 요청에 시퀀스 번호를 할당하고 backup node로 보낸다.
3. Prepare Phase: backup node는 요청을 확인하고 네트워크의 다른 노드에 `Pre-prepare` 메시지를 보낸다.
4. Commit Phase: 노드가 노드의 2/3로부터 `Prepare` 메시지를 수신하면 네트워크의 다른 노드에 `Commit` 메시지를 보낸다.

합의 프로세스는 네트워크의 노드들이 비잔틴 결함이 있는 경우에도 모든 노드가 동일한 상태라면 동의하도록 설계되었다.

특수한 상황을 가정해보자.
네트워크에 있는 노드의 67%가 동일한 결과에 동의하지만 redundancy들이 동의하지 않는 경우 이는 합의 프로세스에 문제가 있음을 나타낸다.
일부 노드가 악의적으로 동작하거나 PBFT 알고리즘 구현에 버그 또는 오류가 있을 수 있다.

이러한 시나리오에서는 문제를 조사하고 해결하기 위한 단계를 수행해야 할 수 있다.
- 한 가지 유효한 접근 방식은 현재 primary 노드가 악의적으로 행동하거나 프로토콜을 따르지 않는 것으로 의심되는 경우
  네트워크가 새 primary 노드로 전환할 수 있도록 하는 PBFT의 메커니즘인 "view change"를 수행하는 것이다.  
  view change 중에 네트워크는 새로운 primary 노드를 선택하고 합의 프로세스의 새로운 라운드를 시작한다.
  새로운 primary 노드가 정직하고 프로토콜을 따르는 경우 네트워크는 합의에 도달하고 공유 상태에 동의할 수 있다.
- 또 다른 접근 방식은 내결함성을 높이고 잘못된 합의 가능성을 줄이기 위해 네트워크에 추가 redundancy를 도입하는 것이다.
  여기에는 네트워크에 더 많은 노드를 추가하거나 Sharding과 같은 기술을 사용하여 네트워크를 더 작은 하위 네트워크로 나누는 것이 포함될 수 있다.

#### PBFT Message Flow
PBFT 메시지 flow는 다음과 같다.

1. 클라이언트는 primary 노드에 요청을 보낸다.
2. primary 노드는 요청에 시퀀스 번호를 할당하고 백업 노드로 보낸다.
3. backup 노드는 요청을 확인하고 네트워크의 다른 노드에 "Pre-prepare" 메시지를 보낸다.
4. 나머지 노드들은 Pre-prepare 메시지를 확인하고 "prepare" 메시지를 네트워크의 다른 노드로 보낸다.
5. 노드가 노드의 2/3로부터 "prepare" 메시지를 수신하면 네트워크의 다른 노드에 "commit" 메시지를 보낸다.
6. 나머지 노드들은 commit 메시지의 유효성을 검사하고 ledger에 요청을 추가한다.

cryptographic 메카니즘을 사용하면 메시지가 인증되고 악의적인 행위자가 노드를 조작할 수 없도록 한다.

#### PBFT Security and Fault Tolerance
PBFT는 네트워크에서 암호화 메커니즘과 redundancy를 사용하여 강력한 보안 및 내결함성을 제공한다.
네트워크 노드의 최대 1/3이 비잔틴일 수 있다고 가정하면 PBFT는 결함이나 악의적인 동작이 있는 경우에도 계속해서 올바르게 작동할 수 있다.
그러나 PBFT에는 리소스 요구 사항(추가적인 redundancy 요구) 및 중앙 집중화 가능성(primary node에게 상당한 권한과 책임이 있다)과 같은 제한 사항과 취약점도 있다.

#### PBFT Performance Characteristics
PBFT는 분산 시스템에 강력한 내결함성과 합의를 제공하도록 설계되었다.
짧은 대기 시간과 높은 처리량, 확장성을 비롯한 크고 복잡한 네트워크가 있는 고성능 애플리케이션에 적합하다.
PBFT는 분산 시스템에서 성능과 확장성을 희생하지 않으면서 내결함성과 합의를 제공하도록 설계되었기 때문이다.

PBFT는 노드가 여러 요청을 병렬로 처리할 수 있는 파이프라이닝이라는 메커니즘을 사용하기 때문에 상대적으로 오버헤드가 적다.
PBFT에서 각 노드는 일련의 단계에서 들어오는 요청을 처리하며 각 단계는 합의 프로세스의 다른 단계를 나타낸다.
이를 통해 노드는 여러 작업을 동시에 수행할 수 있으며 각 요청에 필요한 전체 처리 시간을 줄이는 데 도움이 될 수 있다.

파이프라이닝은 블록체인 네트워크에서는 validator, 즉 각각의 노드들이 병렬로 각자의 연산을 수행하고
파이프라인을 이어서 터치하기 때문에 중앙 네트워크는 많은 연산을 홀로 처리할 필요가 없기 때문에 오버헤드가 적다.
이는 각 노드가 다른 노드가 작업을 완료할 때까지 기다리지 않고 동시에 여러 작업을 수행할 수 있으므로
합의 프로세스가 큰 오버헤드를 차지하지 않는다.

또한 PBFT는 계산상 효율적일 수 있는 메시지 유효성 검사를 위해 암호화 메커니즘을 사용한다.
PBFT는 표준 암호화 알고리즘과 메시지 유효성 검사 기술을 사용하여 합의 프로세스에 추가 오버헤드 또는 계산 복잡성을 도입하는 것을 방지할 수 있다.
여기서 말하는 추가적인 오버헤드 및 계산 복잡성을 방지한다는 뜻은 식별되지 않은 노드 및 악의적인 노드가 합의 프로세스에
접근하지 못하도록 막는다는 뜻이다. 즉 기술적인 효율성보다는 악의적인 공격에 대한 저항성을 의미한다.

PBFT는 높은 성능과 확장성을 저해하지 않으면서 Fault Tolerance를 제공하도록 설계되었지만,
실제로는 PBFT 기반 시스템의 확장성은 네트워크 토폴로지, 메시지 크기, 노드 처리 능력 및 기본 하드웨어 인프라를 비롯한 여러 요인에 따라 달라지기 때문에 
이와 같은 특성을 항상 달성할 수 있는 것은 아니다. 그렇기 때문에 기본 아키텍처와 인프라를 신중하게 설계하고 최적화 해야한다.

### Key features of PBFT
다음은 PBFT의 주요 keyword에 대한 내용의 요약본이다.

1. Fault tolerence: PBFT는 네트워크에 있는 노드의 최대 1/3이 결함이 있거나 악의적일 수 있다고 가정하여 분산 시스템에서 강력한 내결함성을 제공하도록 설계되었다.
2. Consensus: PBFT는 분산 시스템에서 합의를 달성하기 위한 메커니즘을 제공하여 모든 노드가 동일한 결과에 동의하도록 한다.
3. Low latency and high throughput: PBFT는 낮은 대기 시간과 높은 처리량을 저해하지 않도록 설계되어 고성능 애플리케이션에 적합하다.
4. Scalability: PBFT는 확장 가능하며 크고 복잡한 네트워크를 처리할 수 있다.
5. Security: PBFT는 메시지 검증을 위해 암호화 메커니즘을 사용하여 악의적인 공격으로부터 보호하고 합의 프로세스의 무결성을 보장한다.

## Understanding PBFT's Components
### Roles of nodes in PBFT
PBFT에는 클라이언트, redundency 및 primary node의 세 가지 유형의 노드가 있다.
- client: 네트워크에 요청을 제출하는 외부 user이다.
- redundency(replica): 시스템의 현재 상태 사본을 저장하고 합의 프로세스에 참여하는 노드이다.
- primary node: 합의 프로세스를 조정하고 모든 replicas가 동일한 결과에 동의하도록 한다(잠재적 중앙 집권 위험).

### consensus rounds
PBFT는 각각 여러 단계로 구성된 일련의 라운드를 통해 합의를 달성한다.
각 라운드 동안 primary 노드는 모든 replicas에 요청을 보낸 다음 요청을 처리하고 다시 primary 노드로 응답을 보낸다.
primary node가 충분한 응답을 받으면 요청을 시스템 상태로 commit하기 위해 모든 replica에 메시지를 보낼 수 있다.

### message types and format
PBFT는 `Pre-prepare`, `prepare`, `commit` 및 `view change` 메시지를 포함하여 여러 유형의 메시지를 사용한다.
이러한 메시지는 특정 형식을 가지며 처리 중인 요청 및 프로세스에 관련된 노드와 같은 합의 프로세스의 현재 상태에 대한 정보를 포함한다.

### message flow
PBFT의 메시지 흐름은 합의를 달성하고 내결함성을 보장하도록 일련의 sequence flow 규칙이 정해져 있다.([PBFT Message Flow](https://github.com/datactor/Rustic-data-solving/blob/main/forge/distributed_data_management/pbft.md#L66) 참고)

### view changes
PBFT에서는 primary node가 실패하거나 악의적이 되더라도 합의 프로세스가 계속될 수 있도록 `view change`가 사용된다.
`view change` 중에 replicas들은 새로운 primary node를 선출하여 합의 프로세스를 조정하고 모든 replicas가 동일한 결과에 동의하도록 할 수 있다.
